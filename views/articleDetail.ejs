<%- include header.ejs %>
<% var baseURL = "http://localhost:3000/" %>
<link rel="stylesheet" href="<%= baseURL %>/highlight/styles/idea.css" xmlns="http://www.w3.org/1999/html">

<script>hljs.initHighlightingOnLoad()</script>

<html>
<body>
<%- include guideHeader.ejs %>
<% if (title === "article missing") { %>
    <div class="container">
        <div class="col-md-6">
            <h1>文章好像不见了呢 ╮(￣▽￣)╭</h1>
            <a href="mailto:sumover@foxmail.com" class="btn btn-primary btn-sm">联系猫猫找回这篇文章>></a>
        </div>
        <div class="colmd-4">

            <img src="<%= baseURL %>/images/猫猫哭泣.jpg" class="page-header">
        </div>
    </div>
<% } else { %>

    <div class="container" id="container-article-detail">
        <%# 文章头 %>
        <div class="row">
            <div class="col-lg-1">

            </div>
            <div class="col-lg-11 page-header">
                <h1 id="article-title"><%= title %></h1>
                <p>
                    <abbr>
                        标签:
                    </abbr>
                    <template v-for="label in articleLabelList">
                        <a href="#" class="label label-info">{{label}}</a>
                    </template>
                </p>
            </div>
        </div>
        <%# 文章主体 %>
        <div class="row page-header" id="page-header-row">
            <div class="col-lg-1">
                <!--<%#TODO:侧边导航 %>-->
            </div>
            <div class="col-lg-10" id="article-content">
                <%- articleHTML %>
            </div>
        </div>

        <%# 文章评论板块 %>
        <div class="row page-header">
            <div class="col-lg-1">
                <h5 class="text-primary">
                    评论(1233)
                </h5>
            </div>
            <div class="col-lg-8 center-block">
                <textarea id="comment-textarea" placeholder="<%= loginStatus ? "发表一个友善的评论~" : "好像还没登录哦~" %>"
                      <%= !loginStatus ? "disabled" : "" %> >

            </textarea>
            </div>
            <div class="col-lg-1">
                <button class="btn btn-lg btn-primary"
                        style="height: 100px;width: 100px;"
                        <%= !loginStatus ? "disabled" : "" %>
                        @click="publishComment"><%- !loginStatus ? "先登录嘛" : "发表<br>评论" %>
                </button>
            </div>
        </div>
        <%# 盖楼.jpg %>
        <div class="row">
            <div class="col-lg-1"></div>
            <div class="col-lg-8">
                <template v-if="articleCommentList.length === 0">
                    <div class="text-center">
                        好像还没有评论呢...
                    </div>
                </template>
                <div class="panel panel-default" v-for="(comment, index) in articleCommentList">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-lg-4">
                                <p class="text-left text-primary">
                                    {{ comment.publisher }}
                                </p>
                            </div>
                            <div class="col-lg-4">
                                <p class="text-right">
                                    评论于:{{ comment.publishedTime }}
                                </p>
                            </div>
                            <div class="col-lg-4">
                                #{{ index + 1 }}
                            </div>
                        </div>
                    </div>
                    <div class="panel-body">
                        {{ comment.content }}
                    </div>
                </div>
            </div>
        </div>
        <%#显示图片用的模态框%>
        <div class="modal fade" id="img-modal"
             aria-hidden="true">
            <!--            <div class="modal-dialog">-->
            <div class="modal-content col-lg-12">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                </div>
                <div class="modal-body" id="img-modal-body"></div>
                <div class="modal-footer" id="">
                    <p class="text-center" id="img-modal-footer"></p>
                    <!--                    </div>-->
                </div>
            </div>
        </div>
    </div>

    <style>
        textarea {
            width: 100%;
            height: 100px;
            resize: none;
        }

    </style>
    <script>
        var vm_article_detail_container = new Vue({
            el: "#container-article-detail",
            data: {
                articleId: "<%= articleId %>",
                articleLabelList: null,
                articleCommentList: []
            },
            async mounted() {
                // query labels
                var articleLabelListRes = await axios.get("/article/articleLabelList", {
                    params: {articleId: this.articleId}
                });

                if (articleLabelListRes.data.message === "article label list query success")
                    this.articleLabelList = articleLabelListRes.data.articleLabelList;
                else this.articleLabelList = [];

                // query comments
                var articleCommentListRes = await axios.get('/article/articleComments', {
                    params: {aid: this.articleId}
                });
                if (articleCommentListRes.data.message === "query comment success") {
                    this.articleCommentList = articleCommentListRes.data.commentList;
                }

                //  jQuery operation
                $('img').each((index, element) => {
                    element.id = `img-id-${index}`;
                    element.style = "width: 50%; height: 50%;";

                    element.onclick = function () {
                        console.log('show modal');
                        $('#img-modal').modal('show');
                        $('#img-modal-body').html(
                            `<img src="${element.src}" alt=${element.alt} style="height: 100%;width: 100%"> `);
                        $('#img-modal-footer').text(element.alt);
                    };
                    console.log(`img ${index} catch from ${element.src}`);
                    $('table').addClass('table table-bordered table-hover');
                    // var inHTML = $(this).html();
                    // $(this).attr('onclick', `showModal(${inHTML})`)
                });
            },
            methods: {
                publishComment: async () => {

                }
            }
        });
    </script>

<% } %>
<%- include pagefoot.ejs %>
</body>
</html>